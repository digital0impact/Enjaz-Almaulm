# ربط المهنة بمحاور الأداء المهني

هذا الملف يوضح كيف تُربط **المهنة** (المختارة في البيانات الأساسية) مع **محاور الأداء المهني** المعروضة في التطبيق، وأين يحدث هذا الربط في الكود.

---

## 1. أين تُخزَن المهنة؟

- **الشاشة:** تبويب **البيانات الأساسية** (`app/(tabs)/basicData.tsx`).
- **قائمة الخيارات:**  
  `معلم/ة`، `معلم/ة مسند له نشاط طلابي`، `معلم/ة مسند له توجيه صحي`، `الموجه/ه الطلابي`، `وكيل/ة المدرسة`، `مدير/ة المدرسة`، `الجدارات الوظيفية العامة (المشتركة)`، `الجدارات الوظيفية القيادية`.
- **التخزين المحلي:** تُحفظ في `AsyncStorage` تحت المفتاح `basicData`، داخل الحقل `profession`:
  ```ts
  await AsyncStorage.setItem('basicData', JSON.stringify(userData));
  // userData.profession = القيمة المختارة
  ```
- **عند الحفظ:** المستخدم يختار المهنة من نافذة منبثقة ثم يتم استدعاء `updateField('profession', profession)` ثم حفظ `userData` (ومنها `profession`) في `basicData`.

---

## 2. من أين تُقرأ المهنة لصفحة الأداء؟

- **الشاشة:** تبويب **محاور الأداء المهني** (`app/(tabs)/performance.tsx`).
- **الدالة:** `loadUserProfession()`:
  1. تقرأ من `AsyncStorage.getItem('basicData')`.
  2. تستخرج `parsedData.profession` (والافتراضي `'معلم/ة'`).
  3. إن تغيرت المهنة عن القيمة الحالية في الصفحة (`userProfession`) تستدعي `forceUpdateCardsForProfession(newProfession)`.
  4. إن لم تتغير، تستدعي `loadPerformanceData()` لتحميل البيانات المحفوظة.
- **متى تُستدعى:** عند التركيز على الصفحة عبر `useFocusEffect`، وعند تغيير `userProfession` عبر `useEffect`.

---

## 3. كيف تُحدَّد محاور الأداء حسب المهنة؟

- **الدالة الأساسية:** `getPerformanceDataByProfession(profession)` في `app/(tabs)/performance.tsx`.
- **الفكرة:** لكل قيمة من قيم `profession` يُرجع مصفوفة مختلفة من **المحاور** (البطاقات). كل محور يحتوي على:
  - `id`, `title`, `score`, `weight`, `description`, `details`
  - `evidence`: مصفوفة من الشواهد (اسم الشاهد، وهل متوفر).
- **الربط:**
  - `if (profession === 'معلم/ة مسند له نشاط طلابي')` → محاور معلم + محاور **النشاط الطلابي**.
  - `else if (profession === 'معلم/ة مسند له توجيه صحي')` → محاور معلم + محاور **التوجيه الصحي**.
  - `else if (profession === 'الموجه/ه الطلابي')` → محاور **الوظيفي + التوجيه + الإرشاد**.
  - `else if (profession === 'وكيل/ة المدرسة')` → محاور **الوظيفي + الإداري + التطويري + التربوي**.
  - `else if (profession === 'مدير/ة المدرسة')` → نفس التقسيم مع محاور مدير المدرسة.
  - `else if (profession === 'الجدارات الوظيفية العامة (المشتركة)')` → محاور **الجدارات المشتركة** (المسؤولية، العمل الجماعي، المرونة للتغيير، المبادرة).
  - `else if (profession === 'الجدارات الوظيفية القيادية')` → محاور **الجدارات القيادية** (المسؤولية، العمل الجماعي، المرونة للتغيير، المبادرة، قيادة التغيير، تطوير وتمكين الموظفين، التوجه الاستراتيجي، اتخاذ القرارات).
  - **وإلا** (بما فيها `معلم/ة`) → محاور **المعلم العادي** (وظيفي + تعليمي فقط).

أي أن **المهنة هي المفتاح** الذي يحدد أي مجموعة محاور (وبالتالي أي بطاقات وشواهد) تُعرض في صفحة الأداء.

---

## 4. ماذا يحدث عند تغيير المهنة؟

- **الدالة:** `forceUpdateCardsForProfession(profession)` في `performance.tsx`.
  1. حذف البيانات القديمة: `AsyncStorage.removeItem('performanceData')`.
  2. الحصول على المحاور الجديدة: `getPerformanceDataByProfession(profession)`.
  3. تحديث الحالة: `setPerformanceData(newData)`.
  4. حفظ المحاور الجديدة: `AsyncStorage.setItem('performanceData', JSON.stringify(newData))`.

بهذا يصبح ما يُعرض ويُحفظ دائماً مطابقاً للمهنة الحالية.

---

## 5. تحميل البيانات المحفوظة ومطابقتها للمهنة

- **الدالة:** `loadPerformanceData()` في `performance.tsx`.
  1. قراءة `performanceData` من `AsyncStorage`.
  2. حساب المحاور المتوقعة للمهنة الحالية: `getPerformanceDataByProfession(userProfession)`.
  3. **مطابقة:**
     - إذا تطابقت عدد المحاور وعناوينها مع المحفوظ → استخدام المحفوظ (مع تطبيع الشواهد).
     - إذا اختلفت (تغيير مهنة أو بيانات قديمة) → استبدال البيانات بمحاور المهنة الحالية وحفظها.

بهذا يضمن التطبيق أن **محاور الأداء المعروضة والمحفوظة تتوافق دائماً مع المهنة المختارة في البيانات الأساسية**.

---

## 6. التقارير والتقرير التفاعلي

- **التقرير التفاعلي:** `app/interactive-report.tsx`.
  - يقرأ المهنة من `basicData`: `parsedBasicData.profession`.
  - يستخدم `getDefaultPerformanceData(profession)` للحصول على هيكل المحاور حسب المهنة.
  - يتحقق من أن البيانات المحفوظة في `performanceData` تطابق طول وعناوين محاور المهنة الحالية؛ إن لم تتطابق يستبدلها بمحاور المهنة ويحفظ.
  - يستخدم `getCategoryByTitle(title, profession)` لتصنيف كل محور إلى فئة (وظيفي، تعليمي، نشاط طلابي، صحي، توجيه، إرشاد، إداري، تطويري، تربوي) حسب المهنة، لاستخدامها في الرسوم والتصنيفات داخل التقرير.

أي أن **نفس قيمة المهنة** في `basicData` تتحكم في:
- أي محاور تُحمّل وتُعرض في صفحة الأداء.
- أي محاور تُستخدم في التقرير التفاعلي وكيف تُصنَّف (الفئات).

---

## 7. ملخص التدفق

```
[البيانات الأساسية]  →  المستخدم يختار المهنة  →  حفظ في basicData.profession (AsyncStorage)
                                    ↓
[محاور الأداء المهني]  →  loadUserProfession() تقرأ basicData.profession
                                    ↓
                    getPerformanceDataByProfession(profession)  →  محاور مختلفة لكل مهنة
                                    ↓
                    عرض البطاقات + حفظ في performanceData (AsyncStorage)
                                    ↓
[التقرير التفاعلي / تقارير أخرى]  →  تقرأ basicData.profession و performanceData
                                    ↓
                    getDefaultPerformanceData(profession) / getCategoryByTitle(title, profession)
                                    ↓
                    عرض وتصنيف المحاور حسب المهنة
```

---

## 8. الملفات الرئيسية في الكود

| الملف | الدور |
|-------|--------|
| `app/(tabs)/basicData.tsx` | اختيار المهنة، قائمة `professionOptions`، حفظ `userData.profession` في `basicData`. |
| `app/(tabs)/performance.tsx` | `loadUserProfession()`، `getPerformanceDataByProfession(profession)`، `forceUpdateCardsForProfession(profession)`، `loadPerformanceData()` — مصدر محاور الأداء وحفظها. |
| `app/interactive-report.tsx` | قراءة المهنة من `basicData`، `getDefaultPerformanceData(profession)`، `getCategoryByTitle(title, profession)` — توحيد المحاور والفئات مع صفحة الأداء. |

بهذا تكون طريقة ربط المهنة بمحاور الأداء المهني واضحة من مصدر القيمة (البيانات الأساسية) حتى العرض والحفظ والتقارير.
