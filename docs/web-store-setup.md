# إعداد متجر الويب (متجرك الخاص)

يمكنك استخدام **متجر ويب خاص بك** لبيع الاشتراكات عندما يفتح المستخدم التطبيق من المتصفح. التطبيق يوجّه المستخدم إلى الرابط الذي تحدّده بعد الضغط على «اشترك الآن» للخطط المدفوعة.

---

## 1. إضافة رابط المتجر في التطبيق

في ملف `.env` (أو في إعدادات البناء):

```env
EXPO_PUBLIC_WEB_STORE_URL="https://رابط-متجرك.com/checkout"
```

- عند فتح صفحة الاشتراكات من **المتصفح** والضغط على «اشترك الآن» لأي خطة مدفوعة، سيتم فتح هذا الرابط.
- يُضاف تلقائياً معامل الخطة إلى الرابط:
  - `?plan=yearly` للاشتراك السنوي
  - `?plan=half_yearly` للاشتراك النصف سنوي

مثال الرابط النهائي:  
`https://رابط-متجرك.com/checkout?plan=yearly`

---

## 2. ماذا تحتاج في صفحة المتجر؟

صفحتك (على نفس الدومين أو دومين آخر) يجب أن:

1. **تقرأ معامل الخطة** من الرابط (`plan=yearly` أو `plan=half_yearly`).
2. **تعرض السعر والدفع** (Stripe، PayPal، مدى، إلخ).
3. **بعد نجاح الدفع** تسجّل الاشتراك في قاعدة البيانات (Supabase) حتى يظهر في التطبيق.

---

## 3. تسجيل الاشتراك في Supabase بعد الدفع

بعد أن يدفع المستخدم في متجرك، يجب إنشاء سجل اشتراك في جدول `subscriptions` حتى يرى المستخدم أن اشتراكه مفعّل داخل التطبيق.

### الطريقة الأولى: Edge Function في Supabase

أنشئ Edge Function تستقبل طلباً من سيرفر الدفع (webhook) أو من صفحة «شكراً لك» بعد الدفع، وتستدعي إدراجاً في الجدول. مثال منطق الدالة (بعد التحقق من الدفع):

```ts
// مثال منطقي (ليس كوداً جاهزاً للتشغيل كما هو)
const planType = body.plan; // 'yearly' | 'half_yearly'
const userId = body.user_id; // من جلسة المستخدم أو من token
const transactionId = body.payment_id; // من بوابة الدفع

await supabaseAdmin.from('subscriptions').insert({
  user_id: userId,
  plan_type: planType,
  start_date: new Date().toISOString(),
  end_date: endDateAccordingToPlan, // سنة أو 6 أشهر
  status: 'active',
  price: planType === 'yearly' ? 49.99 : 29.99,
  transaction_id: transactionId,
  purchase_verified: true
});
```

يجب أن تحصل الدالة على `user_id` المستخدم (مثلاً من JWT أو من جدول ربط بين جلسة الدفع والمستخدم في تطبيقك).

### الطريقة الثانية: من صفحة «شكراً لك» بعد الدفع

إذا كانت صفحة الدفع على موقعك وتعرّف المستخدم (مثلاً عبر Supabase Auth)، يمكنك من نفس الصفحة استدعاء Supabase (بصلاحيات المستخدم المسجّل دخوله) لإدراج سجل في `subscriptions` بعد التحقق من نجاح الدفع.

---

## 4. أمثلة لبوابات دفع مناسبة للويب

| البوابة | ملاحظة |
|--------|--------|
| **Stripe** | شائع، يدعم الاشتراكات المتكررة و Checkout جاهز. |
| **PayPal** | مدفوعات واشتراكات، سهل الربط. |
| **مدى / بوابة سعودية** | تحتاج عادة سيرفر خلفي أو Edge Function للتحقق وتسجيل الاشتراك. |

---

## 5. ملخص التدفق

1. المستخدم يفتح التطبيق من **المتصفح** → يدخل إدارة الاشتراكات.
2. يضغط «اشترك الآن» على خطة مدفوعة → يفتح `EXPO_PUBLIC_WEB_STORE_URL?plan=yearly` (أو `half_yearly`).
3. في متجرك يدفع المستخدم.
4. بعد نجاح الدفع، متجرك (أو webhook) يسجّل الاشتراك في Supabase.
5. عند عودة المستخدم للتطبيق وتحديث الصفحة أو إعادة فتح إدارة الاشتراكات يظهر الاشتراك الحالي.

إذا رغبت، يمكن في خطوة لاحقة إضافة مثال كامل لـ Stripe Checkout + Edge Function لتفعيل الاشتراك تلقائياً بعد الدفع.
