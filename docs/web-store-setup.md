# إعداد متجر الويب (متجرك الخاص)

يمكنك استخدام **متجر ويب خاص بك** لبيع الاشتراكات عندما يفتح المستخدم التطبيق من المتصفح. التطبيق يوجّه المستخدم إلى الرابط الذي تحدّده بعد الضغط على «اشترك الآن» للخطط المدفوعة.

---

## 1. إضافة رابط المتجر في التطبيق

في ملف `.env` (أو في إعدادات البناء):

```env
EXPO_PUBLIC_WEB_STORE_URL="https://رابط-متجرك.com/checkout"
```

- عند فتح صفحة الاشتراكات من **المتصفح** والضغط على «اشترك الآن» لأي خطة مدفوعة، سيتم فتح هذا الرابط.
- يُضاف تلقائياً معامل الخطة إلى الرابط:
  - `?plan=yearly` للاشتراك السنوي
  - `?plan=half_yearly` للاشتراك النصف سنوي

مثال الرابط النهائي:  
`https://رابط-متجرك.com/checkout?plan=yearly`

---

## 2. ماذا تحتاج في صفحة المتجر؟

صفحتك (على نفس الدومين أو دومين آخر) يجب أن:

1. **تقرأ معامل الخطة** من الرابط (`plan=yearly` أو `plan=half_yearly`).
2. **تعرض السعر والدفع** (Stripe، PayPal، مدى، إلخ).
3. **بعد نجاح الدفع** تسجّل الاشتراك في قاعدة البيانات (Supabase) حتى يظهر في التطبيق.

---

## 3. تسجيل الاشتراك في Supabase بعد الدفع

بعد أن يدفع المستخدم في متجرك، يجب إنشاء سجل اشتراك في جدول `subscriptions` حتى يرى المستخدم أن اشتراكه مفعّل داخل التطبيق.

### الطريقة الأولى: Edge Function في Supabase

أنشئ Edge Function تستقبل طلباً من سيرفر الدفع (webhook) أو من صفحة «شكراً لك» بعد الدفع، وتستدعي إدراجاً في الجدول. مثال منطق الدالة (بعد التحقق من الدفع):

```ts
// مثال منطقي (ليس كوداً جاهزاً للتشغيل كما هو)
const planType = body.plan; // 'yearly' | 'half_yearly'
const userId = body.user_id; // من جلسة المستخدم أو من token
const transactionId = body.payment_id; // من بوابة الدفع

await supabaseAdmin.from('subscriptions').insert({
  user_id: userId,
  plan_type: planType,
  start_date: new Date().toISOString(),
  end_date: endDateAccordingToPlan, // سنة أو 6 أشهر
  status: 'active',
  price: planType === 'yearly' ? 49.99 : 29.99,
  transaction_id: transactionId,
  purchase_verified: true
});
```

يجب أن تحصل الدالة على `user_id` المستخدم (مثلاً من JWT أو من جدول ربط بين جلسة الدفع والمستخدم في تطبيقك).

### الطريقة الثانية: من صفحة «شكراً لك» بعد الدفع

إذا كانت صفحة الدفع على موقعك وتعرّف المستخدم (مثلاً عبر Supabase Auth)، يمكنك من نفس الصفحة استدعاء Supabase (بصلاحيات المستخدم المسجّل دخوله) لإدراج سجل في `subscriptions` بعد التحقق من نجاح الدفع.

### الطريقة الثالثة: Edge Function الجاهزة (استدعاء من متجرك أو ويب هوك سلة)

التطبيق يتضمن **Edge Function** جاهزة باسم `store-subscription-webhook` يمكنك استدعاؤها بعد الدفع في متجرك أو ربطها بويب هوك سلة.

**رابط الاستدعاء (ضع بدل `YOUR_PROJECT_REF` معرّف مشروعك من لوحة Supabase):**
```
https://YOUR_PROJECT_REF.supabase.co/functions/v1/store-subscription-webhook
```

**الاستدعاء المباشر (من صفحة شكراً لك أو من سيرفرك):**
- أرسل `POST` مع:
  - `Content-Type: application/json`
  - Header اختياري: `x-webhook-secret: YOUR_SECRET` (إذا ضبطت السر في Supabase)
- Body مثال:
```json
{
  "email": "البريد الذي سجّل به المستخدم في التطبيق",
  "plan": "yearly",
  "transaction_id": "معرف الطلب أو الفاتورة"
}
```
- `plan` يكون إما `yearly` أو `half_yearly`.

**ربط ويب هوك سلة:**
1. من لوحة تحكم سلة → الإعدادات / التكاملات → **Webhooks**.
2. أضف ويب هوك جديد، الحدث مثلاً: **طلب تم إنشاؤه** (`order.created`) أو **تم تحديث حالة الطلب** (`order.status.updated`).
3. URL: نفس الرابط أعلاه `.../store-subscription-webhook`.
4. إذا ضبطت سراً في Supabase (انظر أدناه)، أضف في رأس الطلب: `x-webhook-secret: YOUR_SECRET` (سلة قد تسمح بإضافة headers مخصصة أو استخدم Zapier/وسيط).
5. الدالة تقرأ بريد العميل من الطلب وتحدد الخطة من اسم/منتج الطلب (سنوي → yearly، نصف سنوي → half_yearly) وتُدخل الاشتراك تلقائياً.

**ضبط سر للويب هوك (موصى به):**
- في Supabase: Project Settings → Edge Functions → إضافة Secret باسم `WEBHOOK_STORE_SECRET` وقيمة سرية.
- في الطلبات المرسلة للدالة أضف الرأس: `x-webhook-secret: نفس القيمة`.

**مهم:** المستخدم يجب أن يكون مسجلاً في التطبيق (Supabase Auth) **بنفس البريد** الذي يشتري به في متجرك حتى يتم ربط الاشتراك بحسابه.

---

## 4. أمثلة لبوابات دفع مناسبة للويب

| البوابة | ملاحظة |
|--------|--------|
| **Stripe** | شائع، يدعم الاشتراكات المتكررة و Checkout جاهز. |
| **PayPal** | مدفوعات واشتراكات، سهل الربط. |
| **مدى / بوابة سعودية** | تحتاج عادة سيرفر خلفي أو Edge Function للتحقق وتسجيل الاشتراك. |
| **سلة (Salla)** | انظر القسم التالي. |

---

## 5. ربط التطبيق بمتجر على منصة سلة (Salla)

إذا كان متجرك يعمل على **منصة سلة**، يمكنك توجيه المستخدم من التطبيق إلى صفحة الدفع في متجرك ثم تسجيل الاشتراك في Supabase بعد إتمام الطلب.

### الخطوة ١: إنشاء منتجات الاشتراك في متجر سلة

1. ادخل إلى **لوحة تحكم متجرك في سلة**.
2. أنشئ **منتجين** (أو أكثر) للاشتراكات:
   - منتج للاشتراك **السنوي** (yearly).
   - منتج للاشتراك **النصف سنوي** (half_yearly).
3. انسخ **رابط كل منتج** أو استخدم صفحة سلة الموحدة (مثلاً صفحة تحتوي على الخيارين).

عادةً يكون الرابط بهذا الشكل:  
`https://متجرك.salla.sa/products/معرف-المنتج`  
أو إذا استخدمت دوميناً مخصصاً:  
`https://yourstore.com/products/معرف-المنتج`

### الخطوة ٢: إضافة رابط المتجر في التطبيق

في ملف **`.env`** في مشروع التطبيق:

```env
# استخدم صفحة checkout في متجر سلة أو صفحة تحتوي على منتجات الاشتراك
EXPO_PUBLIC_WEB_STORE_URL="https://متجرك.salla.sa/cart"
```

أو إذا أردت توجيه المستخدم مباشرة لصفحة منتج معيّن، يمكنك استخدام رابط صفحة المنتج (التطبيق سيضيف `?plan=yearly` أو `?plan=half_yearly` للرابط؛ إذا كانت صفحتك لا تقرأ هذا المعامل يمكنك استخدام صفحة واحدة للدفع ثم التمييز داخل سلة حسب المنتج المشترى).

- عند الضغط على «اشترك الآن» من **المتصفح** سيفتح الرابط مع المعامل:
  - `...?plan=yearly`
  - `...?plan=half_yearly`

### الخطوة ٣: ماذا يحدث بعد الدفع في سلة؟

بعد أن يدفع المستخدم في متجر سلة، تحتاج إلى **تسجيل الاشتراك في جدول `subscriptions`** في Supabase حتى يظهر الاشتراك داخل التطبيق. يمكن ذلك بإحدى الطريقتين:

#### أ) ويب هوك (Webhook) من سلة

- من **لوحة تحكم سلة** → الإعدادات أو التكاملات → **Webhooks**.
- أضف عنوان (URL) لـ **Edge Function** في Supabase تستقبل حدث «تم إنشاء الطلب» أو «تم تأكيد الدفع».
- الـ Edge Function تتحقق من الطلب، تحدّد الخطة من المنتج المشترى، وتُدخل سجلاً في جدول `subscriptions` مع ربط المستخدم (مثلاً عبر **البريد الإلكتروني** للعميل في الطلب إذا كان يطابق مستخدم Supabase).

راجع توثيق سلة: [إرسال الإخطارات عبر Webhooks](https://help.salla.sa/article/157307738).

#### ب) ربط يدوي أو عبر Zapier

- يمكنك استخدام **Zapier** لربط سلة بتطبيقات أخرى (مثلاً عند «طلب جديد» تشغّل سكربت أو تستدعي Edge Function).
- أو تسجيل الاشتراك يدوياً من لوحة Supabase بعد التأكد من الدفع في سلة (مناسب للمتاجر الصغيرة).

### الخطوة ٤: ربط الطلب بالمستخدم في التطبيق

جدول `subscriptions` يحتاج `user_id` (معرّف المستخدم في Supabase). يمكن:

- في الـ Webhook: قراءة **بريد العميل** من طلب سلة، والبحث عن المستخدم في `auth.users` أو جدول profiles بنفس البريد، ثم استخدام `id` ذلك المستخدم في `subscriptions`.
- أو طلب المستخدم إدخال نفس البريد في التطبيق وفي متجر سلة حتى تتم المطابقة تلقائياً.

### ملخص تدفق سلة

1. المستخدم يفتح التطبيق من **المتصفح** → يضغط «اشترك الآن» على خطة مدفوعة.
2. يُفتح رابط متجر سلة مع `?plan=yearly` أو `?plan=half_yearly`.
3. المستخدم يكمّل الشراء والدفع في متجر سلة.
4. بعد الدفع: ويب هوك (أو Zapier/يدوي) يستدعي منطقك لتسجيل الاشتراك في Supabase.
5. عند عودة المستخدم للتطبيق وتحديث صفحة الاشتراكات يظهر الاشتراك الحالي.

---

## 6. ملخص التدفق العام

1. المستخدم يفتح التطبيق من **المتصفح** → يدخل إدارة الاشتراكات.
2. يضغط «اشترك الآن» على خطة مدفوعة → يفتح `EXPO_PUBLIC_WEB_STORE_URL?plan=yearly` (أو `half_yearly`).
3. في متجرك يدفع المستخدم.
4. بعد نجاح الدفع، متجرك (أو webhook) يسجّل الاشتراك في Supabase.
5. عند عودة المستخدم للتطبيق وتحديث الصفحة أو إعادة فتح إدارة الاشتراكات يظهر الاشتراك الحالي.

إذا رغبت، يمكن في خطوة لاحقة إضافة مثال كامل لـ Stripe Checkout + Edge Function لتفعيل الاشتراك تلقائياً بعد الدفع.
