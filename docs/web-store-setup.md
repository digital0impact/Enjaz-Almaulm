# إعداد متجر الويب (متجرك الخاص)

يمكنك استخدام **متجر ويب خاص بك** لبيع الاشتراكات عندما يفتح المستخدم التطبيق من المتصفح. التطبيق يوجّه المستخدم إلى الرابط الذي تحدّده بعد الضغط على «اشترك الآن» للخطط المدفوعة.

---

## 1. إضافة رابط المتجر في التطبيق

في ملف `.env` (أو في إعدادات البناء):

```env
EXPO_PUBLIC_WEB_STORE_URL="https://رابط-متجرك.com/checkout"
```

- عند فتح صفحة الاشتراكات من **المتصفح** والضغط على «اشترك الآن» لأي خطة مدفوعة، سيتم فتح هذا الرابط.
- يُضاف تلقائياً معامل الخطة إلى الرابط:
  - `?plan=yearly` للاشتراك السنوي
  - `?plan=half_yearly` للاشتراك النصف سنوي

مثال الرابط النهائي:  
`https://رابط-متجرك.com/checkout?plan=yearly`

### العودة التلقائية للتطبيق بعد الدفع

يُرسل التطبيق تلقائياً مع رابط المتجر معامل **`return_url`** (رابط صفحة الاشتراكات + `?purchase=success`). إذا كان متجرك أو بوابة الدفع تدعم توجيه العميل بعد نجاح الدفع إلى هذا الرابط، فسيُعاد المستخدم تلقائياً لصفحة الاشتراكات في التطبيق ويُحدَّث اشتراكه.

- رابط العودة يُبنى من عنوان التطبيق الحالي (أو من `EXPO_PUBLIC_APP_URL` في `.env` إن وُجد).
- إن لم يدعم المتجر/البوابة `return_url`، يمكن للمستخدم الرجوع يدوياً لرابط التطبيق أو تحديث الصفحة وسيُحدَّث الاشتراك عند العودة للتبويب.

---

## 2. ماذا تحتاج في صفحة المتجر؟

صفحتك (على نفس الدومين أو دومين آخر) يجب أن:

1. **تقرأ معامل الخطة** من الرابط (`plan=yearly` أو `plan=half_yearly`).
2. **تعرض السعر والدفع** (Stripe، PayPal، مدى، إلخ).
3. **بعد نجاح الدفع** تسجّل الاشتراك في قاعدة البيانات (Supabase) حتى يظهر في التطبيق.

---

## 3. تسجيل الاشتراك في Supabase بعد الدفع

بعد أن يدفع المستخدم في متجرك، يجب إنشاء سجل اشتراك في جدول `subscriptions` حتى يرى المستخدم أن اشتراكه مفعّل داخل التطبيق.

### الطريقة الأولى: Edge Function في Supabase

أنشئ Edge Function تستقبل طلباً من سيرفر الدفع (webhook) أو من صفحة «شكراً لك» بعد الدفع، وتستدعي إدراجاً في الجدول. مثال منطق الدالة (بعد التحقق من الدفع):

```ts
// مثال منطقي (ليس كوداً جاهزاً للتشغيل كما هو)
const planType = body.plan; // 'yearly' | 'half_yearly'
const userId = body.user_id; // من جلسة المستخدم أو من token
const transactionId = body.payment_id; // من بوابة الدفع

await supabaseAdmin.from('subscriptions').insert({
  user_id: userId,
  plan_type: planType,
  start_date: new Date().toISOString(),
  end_date: endDateAccordingToPlan, // سنة أو 6 أشهر
  status: 'active',
  price: planType === 'yearly' ? 49.99 : 29.99,
  transaction_id: transactionId,
  purchase_verified: true
});
```

يجب أن تحصل الدالة على `user_id` المستخدم (مثلاً من JWT أو من جدول ربط بين جلسة الدفع والمستخدم في تطبيقك).

### الطريقة الثانية: من صفحة «شكراً لك» بعد الدفع

إذا كانت صفحة الدفع على موقعك وتعرّف المستخدم (مثلاً عبر Supabase Auth)، يمكنك من نفس الصفحة استدعاء Supabase (بصلاحيات المستخدم المسجّل دخوله) لإدراج سجل في `subscriptions` بعد التحقق من نجاح الدفع.

### الطريقة الثالثة: Edge Function الجاهزة (استدعاء من متجرك أو ويب هوك سلة)

التطبيق يتضمن **Edge Function** جاهزة باسم `store-subscription-webhook` يمكنك استدعاؤها بعد الدفع في متجرك أو ربطها بويب هوك سلة.

**رابط الاستدعاء (ضع بدل `YOUR_PROJECT_REF` معرّف مشروعك من لوحة Supabase):**
```
https://YOUR_PROJECT_REF.supabase.co/functions/v1/store-subscription-webhook
```

**الاستدعاء المباشر (من صفحة شكراً لك أو من سيرفرك):**
- أرسل `POST` مع:
  - `Content-Type: application/json`
  - Header اختياري: `x-webhook-secret: YOUR_SECRET` (إذا ضبطت السر في Supabase)
- Body مثال:
```json
{
  "email": "البريد الذي سجّل به المستخدم في التطبيق",
  "plan": "yearly",
  "transaction_id": "معرف الطلب أو الفاتورة"
}
```
- `plan` يكون إما `yearly` أو `half_yearly`.

**ربط ويب هوك سلة:**
1. من لوحة تحكم سلة → الإعدادات / التكاملات → **Webhooks**.
2. أضف ويب هوك جديد، الحدث مثلاً: **طلب تم إنشاؤه** (`order.created`) أو **تم تحديث حالة الطلب** (`order.status.updated`).
3. URL: نفس الرابط أعلاه `.../store-subscription-webhook`.
4. إذا ضبطت سراً في Supabase (انظر أدناه)، أضف في رأس الطلب: `x-webhook-secret: YOUR_SECRET` (سلة قد تسمح بإضافة headers مخصصة أو استخدم Zapier/وسيط).
5. الدالة تقرأ بريد العميل من الطلب وتحدد الخطة من اسم/منتج الطلب (سنوي → yearly، نصف سنوي → half_yearly) وتُدخل الاشتراك تلقائياً.

**ضبط سر للويب هوك (موصى به):**
- في Supabase: Project Settings → Edge Functions → إضافة Secret باسم `WEBHOOK_STORE_SECRET` وقيمة سرية.
- في الطلبات المرسلة للدالة أضف الرأس: `x-webhook-secret: نفس القيمة`.

**مهم:** المستخدم يجب أن يكون مسجلاً في التطبيق (Supabase Auth) **بنفس البريد** الذي يشتري به في متجرك حتى يتم ربط الاشتراك بحسابه.

---

## 4. أمثلة لبوابات دفع مناسبة للويب

| البوابة | ملاحظة |
|--------|--------|
| **Stripe** | شائع، يدعم الاشتراكات المتكررة و Checkout جاهز. |
| **PayPal** | مدفوعات واشتراكات، سهل الربط. |
| **مدى / بوابة سعودية** | تحتاج عادة سيرفر خلفي أو Edge Function للتحقق وتسجيل الاشتراك. |
| **سلة (Salla)** | انظر القسم التالي. |

---

## 5. ربط التطبيق بمتجر على منصة سلة (Salla)

إذا كان متجرك يعمل على **منصة سلة**، يمكنك توجيه المستخدم من التطبيق إلى صفحة الدفع في متجرك ثم تسجيل الاشتراك في Supabase بعد إتمام الطلب.

### الخطوة ١: إنشاء منتجات الاشتراك في متجر سلة

1. ادخل إلى **لوحة تحكم متجرك في سلة**.
2. أنشئ **منتجين** (أو أكثر) للاشتراكات:
   - منتج للاشتراك **السنوي** (yearly).
   - منتج للاشتراك **النصف سنوي** (half_yearly).
3. انسخ **رابط كل منتج** أو استخدم صفحة سلة الموحدة (مثلاً صفحة تحتوي على الخيارين).

عادةً يكون الرابط بهذا الشكل:  
`https://متجرك.salla.sa/products/معرف-المنتج`  
أو إذا استخدمت دوميناً مخصصاً:  
`https://yourstore.com/products/معرف-المنتج`

### الخطوة ٢: إضافة رابط المتجر في التطبيق

في ملف **`.env`** في مشروع التطبيق:

```env
# استخدم صفحة checkout في متجر سلة أو صفحة تحتوي على منتجات الاشتراك
EXPO_PUBLIC_WEB_STORE_URL="https://متجرك.salla.sa/cart"
```

أو إذا أردت توجيه المستخدم مباشرة لصفحة منتج معيّن، يمكنك استخدام رابط صفحة المنتج (التطبيق سيضيف `?plan=yearly` أو `?plan=half_yearly` للرابط؛ إذا كانت صفحتك لا تقرأ هذا المعامل يمكنك استخدام صفحة واحدة للدفع ثم التمييز داخل سلة حسب المنتج المشترى).

- عند الضغط على «اشترك الآن» من **المتصفح** سيفتح الرابط مع المعامل:
  - `...?plan=yearly`
  - `...?plan=half_yearly`

### الخطوة ٣: ماذا يحدث بعد الدفع في سلة؟

بعد أن يدفع المستخدم في متجر سلة، تحتاج إلى **تسجيل الاشتراك في جدول `subscriptions`** في Supabase حتى يظهر الاشتراك داخل التطبيق. يمكن ذلك بإحدى الطريقتين:

#### أ) ويب هوك (Webhook) من سلة

- من **لوحة تحكم سلة** → الإعدادات أو التكاملات → **Webhooks**.
- أضف عنوان (URL) لـ **Edge Function** في Supabase تستقبل حدث «تم إنشاء الطلب» أو «تم تأكيد الدفع».
- الـ Edge Function تتحقق من الطلب، تحدّد الخطة من المنتج المشترى، وتُدخل سجلاً في جدول `subscriptions` مع ربط المستخدم (مثلاً عبر **البريد الإلكتروني** للعميل في الطلب إذا كان يطابق مستخدم Supabase).

راجع توثيق سلة: [إرسال الإخطارات عبر Webhooks](https://help.salla.sa/article/157307738).

#### ب) ربط يدوي أو عبر Zapier

- يمكنك استخدام **Zapier** لربط سلة بتطبيقات أخرى (مثلاً عند «طلب جديد» تشغّل سكربت أو تستدعي Edge Function).
- أو تسجيل الاشتراك يدوياً من لوحة Supabase بعد التأكد من الدفع في سلة (مناسب للمتاجر الصغيرة).

### الخطوة ٤: ربط الطلب بالمستخدم في التطبيق

جدول `subscriptions` يحتاج `user_id` (معرّف المستخدم في Supabase). يمكن:

- في الـ Webhook: قراءة **بريد العميل** من طلب سلة، والبحث عن المستخدم في `auth.users` أو جدول profiles بنفس البريد، ثم استخدام `id` ذلك المستخدم في `subscriptions`.
- أو طلب المستخدم إدخال نفس البريد في التطبيق وفي متجر سلة حتى تتم المطابقة تلقائياً.

### ملخص تدفق سلة

1. المستخدم يفتح التطبيق من **المتصفح** → يضغط «اشترك الآن» على خطة مدفوعة.
2. يُفتح رابط متجر سلة مع `?plan=yearly` أو `?plan=half_yearly`.
3. المستخدم يكمّل الشراء والدفع في متجر سلة.
4. بعد الدفع: ويب هوك (أو Zapier/يدوي) يستدعي منطقك لتسجيل الاشتراك في Supabase.
5. عند عودة المستخدم للتطبيق وتحديث صفحة الاشتراكات يظهر الاشتراك الحالي.

---

## 6. ملخص التدفق العام

1. المستخدم يفتح التطبيق من **المتصفح** → يدخل إدارة الاشتراكات.
2. يضغط «اشترك الآن» على خطة مدفوعة → يفتح `EXPO_PUBLIC_WEB_STORE_URL?plan=yearly` (أو `half_yearly`).
3. في متجرك يدفع المستخدم.
4. بعد نجاح الدفع، متجرك (أو webhook) يسجّل الاشتراك في Supabase.
5. عند عودة المستخدم للتطبيق وتحديث الصفحة أو إعادة فتح إدارة الاشتراكات يظهر الاشتراك الحالي.

إذا رغبت، يمكن في خطوة لاحقة إضافة مثال كامل لـ Stripe Checkout + Edge Function لتفعيل الاشتراك تلقائياً بعد الدفع.

---

## 7. استكشاف الأخطاء: «لا يتم تحديث الاشتراك بعد الدفع»

- **ويب هوك سلة:** تأكد من ربط حدث «تم إنشاء الطلب» أو «تم تأكيد الدفع» في لوحة سلة بعنوان الـ Edge Function `store-subscription-webhook` (رابط Supabase الخاص بمشروعك). بدون ذلك لا يُنشأ سجل الاشتراك في قاعدة البيانات.
- **مطابقة المستخدم:** الـ Webhook يربط الطلب بالمستخدم عبر **البريد الإلكتروني** أو **رقم الجوال**. يجب أن يكون نفس البريد أو نفس رقم الجوال مسجّلاً في التطبيق (مثلاً في الإعدادات → البيانات الأساسية). إن اختلف الرقم أو البريد في الطلب عن التطبيق فلن يُربط الاشتراك بأي مستخدم.
- **جدول `subscriptions`:** تأكد من وجود جدول باسم `subscriptions` في Supabase (وليس فقط `user_subscriptions`) وبالحقول المطلوبة: `user_id`, `plan_type`, `start_date`, `end_date`, `status`, `price`, `transaction_id`, `purchase_verified`. وأن سياسات RLS تسمح للمستخدم المصادق بقراءة الصفوف الخاصة به (`user_id = auth.uid()`).
- **التأخير:** التطبيق ينتظر جاهزية الجلسة (حتى 3 ثوانٍ) بعد العودة من صفحة الدفع ثم يعيد المحاولة تلقائياً حتى 6 مرات كل 2 ثانية. إن لم يظهر الاشتراك، استخدم زر **«تحقق من اشتراكي»** أو حدّث الصفحة بعد ثوانٍ أو تحقق من لوحة Supabase أن السجل قد أُضيف في جدول `subscriptions`.

### إنشاء جدول `subscriptions` إذا لم يكن موجوداً

إذا ظهرت عندك رسالة مثل **`relation "public.subscriptions" does not exist`** فمعناها أن الجدول لم يُنشأ بعد في مشروعك. أنشئه كالتالي:

1. من لوحة Supabase: **SQL Editor** (محرر SQL).
2. انسخ محتوى الملف **`scripts/create-subscriptions-table.sql`** من المشروع (أو انسخ الأوامر أدناه).
3. الصق في الاستعلام الجديد ثم نفّذ (Run).

الملف ينشئ جدول `subscriptions` بالأعمدة المطلوبة، يفعّل RLS، ويضيف الجدول تلقائياً إلى منشور `supabase_realtime` حتى يعمل التحديث الفوري دون خطوة إضافية.

إذا أردت تنفيذ الـ migration عبر Supabase CLI بدلاً من النسخ: من جذر المشروع نفّذ `supabase db push` (أو استخدم الملف `supabase/migrations/20260221100000_create_subscriptions_table.sql`).

### التأكد من تحديث الاشتراك تلقائياً (Realtime)

التطبيق يستخدم **Supabase Realtime** للاستماع لتغييرات جدول `subscriptions` الخاصة بالمستخدم. عند إدراج أو تحديث سجل الاشتراك (مثلاً بعد ويب هوك الدفع)، يصل التحديث إلى الواجهة فوراً دون الحاجة لتحديث الصفحة.

**لماذا هذه الخطوة ضرورية؟**  
في Supabase، خدمة Realtime تعتمد على **منشورات Postgres (Publications)**. أي جدول تريد أن يصل تغييره فوراً للمتصفح يجب أن يكون مضافاً إلى المنشور المسمّى `supabase_realtime`. الجداول التي لا تُضاف إليه لا تُبثّ عليها أي تغييرات، لذلك التطبيق لن يستقبل حدث "تم إدراج اشتراك جديد" إلا إذا حدّث المستخدم الصفحة أو ضغط «تحقق من اشتراكي».

---

#### تفعيل Realtime لجدول `subscriptions` — خطوة بخطوة

**الطريقة الأولى: من لوحة Supabase (Dashboard)**

1. افتح [لوحة تحكم Supabase](https://app.supabase.com) واختر مشروعك.
2. من القائمة الجانبية اضغط **Database** (قاعدة البيانات).
3. من تحت **Database** اختر **Publications** (المنشورات).  
   - إذا لم تجد **Publications**، ابحث في نفس القسم عن **Replication**؛ في بعض الإصدارات تكون إعدادات المنشورات تحت **Replication** ثم **Publications** أو ضمن نفس الصفحة.
4. في الصفحة ستجد قائمة بمنشورات Postgres. تأكد من وجود منشور باسم **`supabase_realtime`**.
5. اضغط على **`supabase_realtime`** لفتح تفاصيله. ستظهر قائمة الجداول المشمولة في هذا المنشور (جداول يُبثّ عليها التغيير للمتصفح).
6. أضف جدول الاشتراكات:
   - ابحث عن زر **"Add table"** أو **"Add publication"** أو مفتاح تفعيل (Toggle) بجانب الجداول.
   - اختر أو فعّل الجدول **`subscriptions`** (في الـ schema **`public`**، أي `public.subscriptions`).
7. احفظ التغيير إن وُجد زر حفظ. بعد ذلك أي **INSERT** أو **UPDATE** على `subscriptions` سيُرسل تلقائياً للمشتركين عبر Realtime.

**الطريقة الثانية: عبر SQL (بعد إنشاء الجدول)**

إذا كان جدول `subscriptions` موجوداً بالفعل وتريد فقط إضافته لـ Realtime:

1. من لوحة Supabase: **SQL Editor** (محرر SQL).
2. أنشئ استعلاماً جديداً (New query).
3. الصق الأمر التالي ثم نفّذه (Run):

```sql
alter publication supabase_realtime add table public.subscriptions;
```

4. إذا ظهرت **`relation "public.subscriptions" does not exist`** فالجداول غير موجود؛ نفّذ أولاً السكربت **`scripts/create-subscriptions-table.sql`** (انظر القسم «إنشاء جدول subscriptions إذا لم يكن موجوداً» أعلاه).
5. إذا ظهرت رسالة أن الجدول مضاف مسبقاً (مثل "already member") فمعناها أن Realtime مفعّل فعلاً لجدول `subscriptions` ولا حاجة لتكرار الأمر.

**التحقق:**

- بعد الإضافة، عند إنشاء سجل اشتراك جديد (مثلاً عبر ويب هوك المتجر)، يفترض أن يظهر الاشتراك في التطبيق فوراً دون تحديث الصفحة.
- إن لم يظهر، استخدم زر **«تحقق من اشتراكي»** للتحقق يدوياً، وتأكد من أن السجل موجود في جدول `subscriptions` في Supabase وأن سياسات RLS تسمح للمستخدم الحالي بقراءة صفّه.
