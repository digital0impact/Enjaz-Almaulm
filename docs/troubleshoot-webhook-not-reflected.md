# استكشاف: الويب هوك مربوط لكن الاشتراك لا يظهر في التطبيق

اتّبع الخطوات بالترتيب لتحديد سبب عدم انعكاس الشراء في التطبيق.

---

## 1) التحقق من سجلات الدالة (Logs) في Supabase

1. ادخل [Supabase Dashboard](https://supabase.com/dashboard) → مشروعك.
2. من القائمة: **Edge Functions** → **salla-webhook** (أو **store-subscription-webhook** حسب الرابط المستخدم في سلة).
3. افتح تبويب **Logs**.
4. أتمم عملية شراء تجريبية من متجر سلة (أو غيّر حالة طلب إلى «مكتمل»).
5. انتظر دقيقة ثم حدّث الـ Logs.

**ماذا تبحث عنه:**

| ما يظهر في الـ Logs | المعنى |
|---------------------|--------|
| **لا يظهر أي استدعاء جديد** | سلة لم ترسل طلباً إلى الرابط. راجع: الرابط في إعدادات الويب هوك صحيح؟ الحدث المختار هو «تم تحديث حالة الطلب» أو «طلب تم إنشاؤه»؟ حالة الطلب في سلة أصبحت مكتملة/تم التوصيل؟ |
| **استدعاء مع استجابة 200 و body فيه `success: true`** | الدالة نجحت وأدرجت اشتراكاً. انتقل إلى الخطوة 2. |
| **استدعاء مع 404 و "No user found"** | الدالة لم تجد مستخدماً يطابق البريد أو الجوال. انتقل إلى الخطوة 3. |
| **استدعاء مع 409 (Same plan / Upgrade only)** | منطق الدالة يمنع الإدراج (نفس الباقة أو ترقية للأسفل). انتقل إلى الخطوة 4. |
| **استدعاء مع 400 (Invalid body)** | تنسيق الطلب من سلة غير متوقع. راجع أن الحدث المرسل يحتوي على بيانات الطلب كما في توثيق سلة. |

---

## 2) التحقق من جدول subscriptions

إذا كانت الاستجابة في الـ Logs **200** و `success: true`:

1. في Supabase: **Table Editor** → **subscriptions**.
2. ابحث عن صف جديد لهذا الطلب (مثلاً `transaction_id` يبدأ بـ `salla-` وتاريخ قريب من وقت الشراء).
3. تأكد أن عمود **user_id** يطابق **معرّف المستخدم** الذي تسجّل به في التطبيق.

**معرّف المستخدم (user_id):**

- من التطبيق: صعب معرفته دون أدوات مطوّر.
- من Supabase: **Authentication** → **Users** — ابحث بالبريد أو أنشئ مستخدماً تجريبياً وانسخ الـ UUID. أو شغّل في SQL Editor الاستعلام من **scripts/list-users-for-webhook.sql** لمقارنة البريد/الجوال مع الـ user_id.

**إن وُجد الصف وكان user_id صحيحاً لكن التطبيق لا يزال يعرض «مجاني»:**

- في التطبيق افتح **خطط الاشتراك** واضغط **«تحقق من اشتراكي»** أو **«تحديث»**.
- أعد فتح الصفحة أو أعد تشغيل التطبيق (أحياناً التطبيق يخزّن الحالة).
- تأكد أنك مسجّل الدخول **بنفس الحساب** الذي يطابق الـ user_id في الجدول.

---

## 3) حل «No user found» (404)

الدالة تربط الطلب بالمستخدم عبر **البريد الإلكتروني** أو **رقم الجوال** فقط. يجب أن يتطابق أحدهما بين:

- **ما أُدخل في طلب سلة** (بريد العميل أو رقم الجوال في صفحة الطلب)،  
و  
- **ما مُسجّل في التطبيق** (حساب الدخول أو **الإعدادات → البيانات الأساسية**).

**ما تفعله:**

1. في التطبيق: **الإعدادات** → **البيانات الأساسية** — تحقق من **البريد** و **رقم الجوال** المسجّلين.
2. في طلب سلة (أو في تصدير الطلبات): تحقق من البريد والجوال المُدخلين للعميل.
3. يجب أن يكونا **نفس القيمة** (بعد تطبيع الأرقام: مثلاً 05xx و 9665xx يُعتبران نفس الرقم في الدالة).
4. إن كان الجوال في التطبيق مختلفاً عن المتجر: حدّث **البيانات الأساسية** في التطبيق ليطابق رقم الطلب، ثم يمكنك إما:
   - إعادة إرسال الويب هوك من سلة إن وُجد خيار «إعادة المحاولة»، أو  
   - إضافة الاشتراك يدوياً عبر **scripts/add-subscription-by-phone.sql** (استبدل رقم الجوال ونوع الخطة ثم شغّل في SQL Editor).

---

## 4) حل «Same plan already active» أو «Upgrade only» (409)

- **Same plan:** يوجد اشتراك نشط لنفس الباقة (سنوي أو نصف سنوي) لهذا المستخدم. الدالة لا تُدخل تكراراً.
- **Upgrade only:** المستخدم لديه باقة أعلى (مثلاً سنوي) والطلب الحالي نصف سنوي — الدالة ترفض «الترقية للأسفل».

لا حاجة لتعديل شيء إن كان السلوك مقصوداً. إن أردت إضافة اشتراك مختلف يدوياً (لسبب استثنائي)، يمكن استخدام **scripts/add-subscription-by-phone.sql** أو تعديل السجلات في Table Editor بحذر.

---

## 5) التأكد من الرابط والحدث في سلة

- **الرابط:** يجب أن يكون بالضبط رابط الدالة التي تنشرها (مثلاً `salla-webhook` أو `store-subscription-webhook`):  
  `https://jwdyslxetmqxebeujphn.supabase.co/functions/v1/salla-webhook`
- **الحدث:** اختر **تم تحديث حالة الطلب** (وإن وُجد **طلب تم إنشاؤه** يمكن إضافته). بدون حدث الطلب لن ترسل سلة البيانات.
- **حالة الطلب:** الدالة تُدرج الاشتراك فقط عندما تكون حالة الطلب **مكتمل** أو **تم التوصيل** (وفق الكود). إذا بقي الطلب «قيد المعالجة» أو «معلق» فلن يُنشأ اشتراك.

---

## 6) ملخص سريع

| المشكلة | الإجراء |
|---------|---------|
| لا يظهر استدعاء في Logs | تصحيح الرابط والحدث في سلة، والتأكد من اكتمال الطلب. |
| 404 No user found | تطابق البريد أو الجوال بين الطلب في سلة والبيانات الأساسية في التطبيق. |
| 409 Same plan / Upgrade only | سلوك مقصود؛ أو إضافة يدوية عند الحاجة. |
| 200 success لكن لا يظهر في التطبيق | التحقق من وجود الصف في subscriptions والـ user_id الصحيح، ثم الضغط «تحقق من اشتراكي» أو «تحديث» في صفحة الاشتراك. |

بعد تطبيق الخطوة المناسبة، أعد المحاولة بطلب تجريبي وتحقق من الـ Logs وجدول **subscriptions** ثم التطبيق.
