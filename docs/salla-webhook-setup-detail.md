# إعداد ويب هوك سلة — شرح مفصل خطوة بخطوة

هذا الدليل يشرح **بالتفصيل** كيف تضيف ويب هوك في لوحة متجر سلة بحيث عند اكتمال الطلب تُستدعى دالة **salla-webhook** (أو store-subscription-webhook) على Supabase لتفعيل الاشتراك تلقائياً.

---

## الرابط الذي ستضعه في سلة

للدالة **salla-webhook**:

```
https://jwdyslxetmqxebeujphn.supabase.co/functions/v1/salla-webhook
```

انسخ هذا الرابط كما هو — ستضعه لاحقاً في حقل **رابط الـ URL** في إعدادات الويب هوك.

---

## الخطوة 1: الدخول إلى لوحة تحكم متجر سلة

1. افتح متصفحك وادخل إلى موقع [سلة](https://salla.sa) (أو الفرع الذي تستخدمه للتجار).
2. سجّل الدخول بحساب **التاجر** (مالك المتجر أو مديره).
3. بعد تسجيل الدخول ستظهر لوحة التحكم الخاصة بمتجرك.

---

## الخطوة 2: الوصول إلى صفحة الويب هوكس

مكان إعداد الويب هوكس قد يختلف قليلاً حسب إصدار لوحة سلة. جرّب المسارات التالية:

### المسار الشائع

1. من القائمة الجانبية أو العلوية ابحث عن أحد الخيارات:
   - **أدوات المطور** أو **Developer**
   - **التكاملات** أو **Integrations**
   - **الإعدادات** → **الإعدادات المتقدمة** أو **Settings** → **Advanced**
2. داخل هذه الصفحة ابحث عن قسم اسمه:
   - **الويب هوك** / **Webhooks**
   - أو **واجهات برمجة التطبيقات** ثم **Webhooks**
3. اضغط على **الويب هوك** لفتح قائمة الويب هوكس.

### إن لم تجد الخيار

- استخدم مربع البحث داخل لوحة سلة وابحث عن **"ويب هوك"** أو **"Webhook"**.
- أو من **الإعدادات** → **قنوات البيع** / **التكاملات** — أحياناً يكون الويب هوك ضمن تكاملات الطلبات.

بعد الوصول ستظهر صفحة تعرض قائمة الويب هوكس الحالية (قد تكون فارغة) وزر مثل **إضافة ويب هوك** أو **Create Webhook**.

---

## الخطوة 3: إضافة ويب هوك جديد

1. اضغط **إضافة ويب هوك** (أو **Create Webhook** / **Add Webhook**).
2. ستظهر نموذج أو شاشة تحتوي على حقول مثل:
   - **رابط الـ URL** (أو Webhook URL / Endpoint URL)
   - **الحدث** (أو Event / الحدث)
   - أحياناً **الطريقة** (Method) — يجب أن تكون **POST**
   - أحياناً خيار لإضافة **رؤوس مخصصة** (Custom Headers)

---

## الخطوة 4: تعبئة حقل رابط الـ URL

| الحقل في سلة       | ماذا تكتب |
|--------------------|------------|
| **رابط الـ URL**   | الصق الرابط التالي **بالكامل** كما هو: |

```
https://jwdyslxetmqxebeujphn.supabase.co/functions/v1/salla-webhook
```

- تأكد أن الرابط يبدأ بـ `https://` ولا يوجد مسافة أو حرف زائد في البداية أو النهاية.
- لا تضف أي شيء بعد الرابط (مثل `?key=...` أو مسارات إضافية) إلا إذا كان لديك سبب خاص.

---

## الخطوة 5: اختيار حدث الطلبات

يجب أن تخبر سلة **متى** ترسل البيانات إلى الرابط. لهذا المشروع نحتاج حدثاً يصدر عند إنشاء الطلب أو عند اكتمال/تحديث حالة الطلب.

### الأحداث المناسبة (اختر واحداً أو كليهما إن وُجد)

| الاسم المعروض في سلة (تقريبي) | المعنى التقني (إن وُجد) | التوصية |
|--------------------------------|-------------------------|----------|
| **طلب تم إنشاؤه**              | `order.created`         | مفيد لتفعيل الاشتراك فور إنشاء الطلب |
| **تم تحديث حالة الطلب**       | `order.status.updated`  | **مهم** — الدالة تتحقق من الحالة وتفعّل الاشتراك عند اكتمال الطلب (مثلاً completed / delivered) |

- إن أمكن، اختر **كلا** الحدثين: **طلب تم إنشاؤه** و **تم تحديث حالة الطلب** حتى يعمل الربط عند إنشاء الطلب وعند تغيير الحالة إلى مكتمل.
- إذا كان الخيار واحداً فقط، اختر **تم تحديث حالة الطلب** ثم في سلة عند اكتمال الطلب (مثلاً وضع "مكتمل" أو "تم التوصيل") سيُرسل الويب هوك.

---

## الخطوة 6: (اختياري) إضافة الرأس السري x-webhook-secret

هذه الخطوة **ضرورية فقط** إذا كنت قد ضبطت في Supabase متغيراً سرياً باسم **WEBHOOK_STORE_SECRET** لحماية الدالة من الاستدعاء من غير سلة.

### لماذا نضيف الرأس؟

- الدالة **salla-webhook** (و store-subscription-webhook) تقرأ قيمة من رأس الطلب (مثلاً `x-webhook-secret` أو `Authorization`).
- إذا كانت قيمة الرأس **مساوية** لقيمة **WEBHOOK_STORE_SECRET** في Supabase، الطلب مقبول.
- إذا لم تتطابق (أو لم يُرسل الرأس)، الدالة ترجع **401 Unauthorized** وترفض الطلب.

لذلك يجب أن تكون القيمة في سلة **نفسها** بالضبط القيمة في Supabase.

### أين أضبط السر في Supabase؟

1. ادخل [Supabase Dashboard](https://supabase.com/dashboard) واختر مشروعك.
2. من القائمة: **Project Settings** (أيقونة الترس) → **Edge Functions**.
3. في قسم **Secrets** (أو **Function Secrets**) اضغط **Add new secret** (أو **Manage secrets**).
4. **Name:** `WEBHOOK_STORE_SECRET`
5. **Value:** اختر نصاً سرياً قوياً (مثال: `my-salla-secret-2024-xyz`) — **احفظه**؛ ستضعه في سلة.
6. احفظ السِر.

### أين أضيف الرأس في سلة؟

في نموذج إضافة الويب هوك، ابحث عن قسم مثل:

- **رؤوس مخصصة** / **Custom Headers**
- أو **Headers**
- أو **إعدادات متقدمة** ثم **Headers**

ثم أضف رأساً واحداً:

| اسم الرأس (Header Name) | قيمة الرأس (Header Value)     |
|-------------------------|-------------------------------|
| `x-webhook-secret`      | نفس القيمة التي وضعتها في Supabase (مثلاً `my-salla-secret-2024-xyz`) |

- الاسم يجب أن يكون **بالضبط** `x-webhook-secret` (حروف صغيرة، مع الشرطة).
- القيمة يجب أن تطابق **حرفاً بحرف** قيمة **WEBHOOK_STORE_SECRET** في Supabase (بدون مسافات زائدة).

### إذا لم تضبط WEBHOOK_STORE_SECRET

- إذا **لم** تضف السِر في Supabase، الدالة لا تتحقق من الرأس — أي طلب يصل للرابط يُقبل من ناحية المصادقة.
- في هذه الحالة **لا تحتاج** إلى إضافة أي رؤوس في سلة؛ اترك قسم الرؤوس فارغاً إن وُجد.

---

## الخطوة 7: حفظ الويب هوك

1. راجع الرابط والحدث (والرأس إن أضفته).
2. اضغط **حفظ** أو **Create** / **إضافة**.
3. بعد الحفظ قد تظهر سلة رسالة نجاح أو تعرض الويب هوك الجديد في القائمة مع حالته (مفعّل عادة).

---

## ملخص سريع

| ما تفعله              | أين                         | القيمة / الإجراء |
|------------------------|-----------------------------|-------------------|
| رابط الاستدعاء         | حقل **رابط الـ URL** في سلة | `https://jwdyslxetmqxebeujphn.supabase.co/functions/v1/salla-webhook` |
| متى يُرسل الطلب        | حقل **الحدث**               | **طلب تم إنشاؤه** و/أو **تم تحديث حالة الطلب** |
| السر (إن وُجد في Supabase) | قسم **رؤوس مخصصة** في سلة   | اسم: `x-webhook-secret` — قيمة: نفس **WEBHOOK_STORE_SECRET** |

---

## بعد الإعداد

- عند اكتمال طلب في متجر سلة (بريد أو جوال العميل يطابق مستخدماً في التطبيق)، سلة ترسل طلب **POST** إلى الرابط أعلاه.
- الدالة تستخرج البريد/الجوال والمنتجات، تحدّد الباقة (سنوي/نصف سنوي)، تبحث عن المستخدم في Supabase، وتُدخل اشتراكاً في جدول **subscriptions**.
- للتأكد: نفّذ طلب تجريبي من المتجر وراجع **Edge Functions** → **salla-webhook** → **Logs** في Supabase، أو تحقق من جدول **subscriptions** ووجود سجل جديد للمستخدم.

للتفاصيل عن الربط بين الطلب والمستخدم (البريد/الجوال) وشروط أسماء المنتجات، راجع الملف `docs/salla-webhook-ربط-سلة.md`.
