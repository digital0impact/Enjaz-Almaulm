# مقارنة تصدير التقرير التفاعلي وتصدير الخطة الفردية (IDP)

## 1. الصيغ المدعومة

| الجانب | التقرير التفاعلي | خطة التطوير الفردية (IDP) |
|--------|------------------|---------------------------|
| **PDF** | ✅ مدعوم (تصدير مباشر أو عبر طباعة على الويب) | ✅ مدعوم |
| **Word** | ❌ غير متوفر | ✅ مدعوم (ملف .doc من HTML) |
| **تحميل HTML (ويب)** | ✅ متوفر عند عدم الاشتراك أو كبديل (تحميل ملف .html ثم طباعة يدوية) | ❌ غير متوفر |

---

## 2. التحقق قبل التصدير (تسجيل الدخول والاشتراك)

| الجانب | التقرير التفاعلي | الخطة الفردية (IDP) |
|--------|------------------|----------------------|
| **تسجيل الدخول** | ✅ يُتحقق من المستخدم عبر `AuthService.getCurrentUser()` و `checkAuthStatus()`؛ إن لم يكن مسجلاً يُطلب منه تسجيل الدخول | ❌ لا يوجد تحقق؛ التصدير متاح مباشرة |
| **الاشتراك المدفوع** | ✅ يُتحقق من `SubscriptionService.checkSubscriptionStatus()`؛ إن لم تكن ميزة `canExport` مفعّلة يُعرض تنبيه مع خيار «عرض الخطط» أو «تحميل التقرير» (HTML) | ❌ لا يوجد تحقق من الاشتراك |
| **النتيجة** | التصدير PDF «الرسمي» محصور بالمشتركين؛ غير المشتركين يمكنهم تحميل HTML وطباعته يدوياً | التصدير PDF و Word متاحان لجميع المستخدمين دون قيد |

---

## 3. مصدر المحتوى (بناء HTML)

| الجانب | التقرير التفاعلي | الخطة الفردية (IDP) |
|--------|------------------|----------------------|
| **الدالة** | `generateReportHTML()` **async** | `generateIDPHtml()` **sync** |
| **مصدر البيانات** | يجلب من التخزين عند التصدير: `basicData`, `performanceData` (من AsyncStorage)، `uploadedFiles`؛ ويحسب الإحصائيات والتوصيات من البيانات المحفوظة | يستخدم **حالة الصفحة الحالية** (state): الاسم، الجهة، التواريخ، الأهداف 70/20/10، جدول الأولويات؛ لا جلب إضافي من التخزين عند الضغط على التصدير |
| **الشعار** | يحاول تحميل شعار الوزارة من الأصل المحلي (expo-asset + FileSystem) ودمجه كـ base64؛ إن فشل يستخدم رابط افتراضي | لا يضم شعاراً في الـ HTML |
| **حجم الـ HTML** | كبير (رأس، إحصائيات، فئات، قائمة أداء، توصيات، شواهد، جداول، تنسيق مطول) | متوسط (عنوان، أقسام، جداول 70-20-10 والأهداف فقط) |

---

## 4. سلوك التصدير PDF

| الجانب | التقرير التفاعلي | الخطة الفردية (IDP) |
|--------|------------------|----------------------|
| **الويب** | فتح نافذة جديدة بالـ HTML ثم استدعاء `print()` بعد 500ms و 2000ms؛ المستخدم يختار «حفظ كـ PDF» من نافذة الطباعة | نفس الفكرة: فتح نافذة بالـ HTML ثم `print()` بعد 500ms؛ رسالة توجيه للمستخدم لاختيار «حفظ كـ PDF» |
| **موبايل (expo-print)** | `Print.printToFileAsync({ html, base64: false, width: 595, height: 842 })` ثم مشاركة الملف | نفس الاستدعاء: `Print.printToFileAsync({ html, base64: false, width: 595, height: 842 })` ثم مشاركة الملف |
| **بعد إنشاء PDF (iOS)** | `Sharing.shareAsync(uri, { UTI: '.pdf', mimeType: 'application/pdf' })` مباشرة (بدون نقل الملف) | نفس الطريقة |
| **بعد إنشاء PDF (Android)** | نقل الملف إلى `FileSystem.documentDirectory` باسم `تقرير_الأداء_YYYY-MM-DD.pdf` ثم `Sharing.shareAsync(pdfUri, ...)` | نقل الملف إلى `documentDirectory` باسم `خطة_التطوير_الفردية_YYYY-MM-DD.pdf` ثم مشاركته |
| **إن تعذرت المشاركة** | عرض رسالة تحتوي مسار الملف | عرض رسالة تحتوي المسار (IDP) أو نص «تم إنشاء ملف PDF. المسار: » + uri (التقرير) |

---

## 5. تصدير Word (IDP فقط)

| الجانب | الخطة الفردية (IDP) |
|--------|----------------------|
| **الويب** | إنشاء Blob من HTML مع BOM (`\ufeff`) ونوع `application/msword`، ثم تحميل عبر `<a download>` باسم `خطة_التطوير_الفردية_YYYY-MM-DD.doc` |
| **موبايل** | كتابة نفس الـ HTML (مع BOM) إلى ملف `.doc` في `FileSystem.documentDirectory` ثم `Sharing.shareAsync` مع `mimeType: 'application/msword'` |
| **التقرير التفاعلي** | لا يوجد تصدير Word |

---

## 6. واجهة المستخدم (زر التصدير)

| الجانب | التقرير التفاعلي | الخطة الفردية (IDP) |
|--------|------------------|----------------------|
| **عدد الأزرار** | زر واحد: «تصدير التقرير» | زرّان: «تصدير PDF» و «تصدير Word» |
| **الموقع** | داخل منطقة المحتوى (قسم actionButtons) فوق شريط التنقل | قسم مستقل «تصدير الخطة» في أسفل الصفحة (قبل الـ spacer) |
| **أثناء التصدير** | تعطيل الزر وعرض `ActivityIndicator` مع نص «جاري التصدير...» | تعطيل كلا الزرّين وعرض `ActivityIndicator` داخل الزر المضغوط |
| **الأيقونة** | `square.and.arrow.up.fill` | PDF: أيقونة `doc.pdf`؛ Word: أيقونة `doc.text.fill` |

---

## 7. معالجة الأخطاء والرسائل

| الجانب | التقرير التفاعلي | الخطة الفردية (IDP) |
|--------|------------------|----------------------|
| **فشل إنشاء HTML** | تنبيه «خطأ في إنشاء التقرير» مع رسالة تفصيلية | لا يوجد مسار منفصل؛ أي خطأ يظهر في catch التصدير |
| **فشل التصدير (PDF)** | تنبيه «فشل التصدير» مع رسالة الخطأ مضافة للنص | تنبيه «فشل التصدير» مع رسالة الخطأ |
| **الويب بدون نوافذ منبثقة** | تنبيه يطلب السماح بالنوافذ أو استخدام معاينة وطباعة | تنبيه يطلب السماح بالنوافذ (PDF) أو تنبيه «تصدير غير متاح» (Word) |
| **نجاح** | «تم بنجاح» + «تم تصدير التقرير كملف PDF» | «تم بنجاح» + نص مختلف لـ PDF أو Word |

---

## 8. ملخص الفروقات الرئيسية

| المعيار | التقرير التفاعلي | الخطة الفردية (IDP) |
|---------|------------------|----------------------|
| **صيغ التصدير** | PDF فقط (وHTML كبديل على الويب) | PDF + Word |
| **التحقق (دخول/اشتراك)** | نعم؛ التصدير PDF «الرسمي» للمشتركين فقط | لا |
| **مصدر البيانات عند التصدير** | جلب من AsyncStorage + حساب إحصائيات وتوصيات | state الحالي للنموذج فقط |
| **بناء HTML** | async، مع شعار وبيانات أساسية وأداء وشواهد | sync، من state فقط، بدون شعار |
| **الويب PDF** | نافذة طباعة مع تأخير مزدوج (500ms و 2000ms) | نافذة طباعة مع تأخير 500ms |
| **الويب بديل بدون اشتراك** | تحميل ملف HTML لطباعته يدوياً | لا يوجد |
| **واجهة التصدير** | زر واحد | زرّان (PDF و Word) |

إذا أردت توحيد السلوك (مثلاً إضافة تحقق اشتراك لـ IDP، أو إضافة تصدير Word للتقرير، أو جعل مصدر بيانات IDP من التخزين عند التصدير)، يمكن تحديد المطلوب وسنضبط الكود وفقه.
