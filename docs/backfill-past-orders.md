# ربط المشتريات السابقة (قبل تفعيل الويب هوك) بـ Supabase

إذا كانت لديك طلبات اكتملت **قبل** إعداد ويب هوك سلة، يمكنك **التحقق منها وربطها** يدوياً بحيث تُنشأ اشتراكات للمستخدمين في جدول `subscriptions`.

---

## الخيار 1: تصدير الطلبات من سلة ثم تشغيل السكربت (موصى به)

### الخطوة 1: تصدير الطلبات من لوحة سلة

1. ادخل إلى **لوحة تحكم متجرك في سلة**.
2. اذهب إلى **الطلبات** (Orders).
3. استخدم خيار **تصدير الطلبات** أو **قوالب التصدير** (إن وُجد) لتحميل الطلبات بصيغة Excel أو CSV.
4. راجع الملف المُصدَّر: تأكد أن فيه أعمدة مثل (أو ما يعادلها):
   - بريد العميل أو رقم الجوال
   - رقم/معرّف الطلب
   - اسم المنتج (أو الخطة: سنوي / نصف سنوي)
   - تاريخ الطلب
   - حالة الطلب (نريد الطلبات **المكتملة** فقط)

تفاصيل التصدير من سلة: [تصدير الطلبات - مركز مساعدة سلة](https://help.salla.sa/article/1765308414).

### الخطوة 2: تحويل البيانات إلى ملف JSON

أنشئ ملفاً باسم `past-orders.json` في مجلد `scripts/` (أو استخدم الاسم في الأمر لاحقاً). الصيغة:

```json
[
  {
    "email": "عميل1@example.com",
    "phone": "0512345678",
    "product_name": "اشتراك سنوي",
    "order_id": "salla-12345",
    "order_date": "2025-01-15"
  },
  {
    "email": "",
    "phone": "966512345678",
    "product_name": "اشتراك نصف سنوي",
    "order_id": "salla-12346",
    "order_date": "2025-01-20"
  }
]
```

- **email** أو **phone**: واحد منهما على الأقل مطلوب (نفس ما يُستخدم في التطبيق).
- **product_name**: اسم المنتج من سلة؛ السكربت يحدد الخطة منه (كلمة "سنوي" → yearly، "نصف" أو "half" → half_yearly).
- **order_id** و **order_date**: اختياريان (لتوثيق الطلب في `transaction_id` والتسجيل).

احتفظ فقط بالطلبات **المكتملة** التي تريد ربطها. احذف من الملف أي طلب لا يجب أن يُنشأ له اشتراك.

### الخطوة 3: تشغيل سكربت الربط

من مجلد المشروع في الطرفية:

```bash
node scripts/backfill-past-orders.js scripts/past-orders.json
```

أو إذا كان الملف في مكان آخر:

```bash
node scripts/backfill-past-orders.js "المسار/إلى/past-orders.json"
```

يحتاج السكربت إلى متغيرات البيئة:

- `SUPABASE_URL`: رابط مشروع Supabase (مثل `https://jwdyslxetmqxebeujphn.supabase.co`)
- `SUPABASE_SERVICE_ROLE_KEY`: مفتاح الخدمة (Service Role) من Supabase → Project Settings → API

يمكنك إنشاء ملف `.env` في جذر المشروع (ولا ترفعه إلى Git) ثم تشغيل السكربت بعد تحميل المتغيرات، أو تعيينها في الطرفية قبل الأمر.

**ماذا يفعل السكربت:**

- يقرأ كل عنصر من `past-orders.json`.
- يبحث عن مستخدم في Supabase بنفس **البريد** أو **رقم الجوال** (مطابقة كما في ويب هوك سلة).
- يحدد الخطة من **product_name** (سنوي / نصف سنوي).
- يتحقق من عدم وجود اشتراك **نفس الباقة** مسبقاً، وأن الترقية للأعلى فقط.
- يُدخل سجلاً في جدول `subscriptions` مع `transaction_id: salla-<order_id>` و `purchase_verified: true`.

أي طلب لا يُجد له مستخدماً أو يتعارض مع قواعد الاشتراك يُطبَع في السجلات ولا يُدرج.

---

## الخيار 2: إضافة اشتراك يدوي لطلب واحد (SQL)

إذا كان عدد الطلبات قليلاً وترغب بالربط يدوياً من Supabase:

1. استخدم السكربت الجاهز: **`scripts/add-subscription-by-phone.sql`** (أو الإصدار حسب البريد إن وُجد).
2. ضع **رقم الجوال** أو البريد المستخدم في الطلب، ونوع الخطة (**yearly** أو **half_yearly**).
3. شغّل الجمل في **Supabase → SQL Editor** كما موضّح داخل الملف.

هذا يربط **مستخدم واحد** بطلب واحد فقط في كل مرة.

---

## الخيار 3: التحقق فقط (بدون إدراج)

إذا أردت فقط **التحقق** من الطلبات التي لم تُربط بعد (بدون إنشاء اشتراكات تلقائياً):

1. صدّر الطلبات من سلة كما في الخيار 1.
2. قارن يدوياً:
   - قائمة الطلبات المكتملة (بريد/جوال، منتج، تاريخ).
   - جدول **subscriptions** في Supabase (مع **transaction_id** يبدأ بـ `salla-` أو تاريخ قريب من تاريخ الطلب).
3. أي طلب مكتمل لا يوجد له سجل في **subscriptions** يُعتبر "لم يُربط بعد" — يمكنك إضافته عبر السكربت (الخيار 1) أو يدوياً (الخيار 2).

**التحقق فقط (بدون إدراج):** شغّل السكربت مع `--dry-run` ليطبع ما كان سيفعله دون الإدراج الفعلي:

```bash
node scripts/backfill-past-orders.js scripts/past-orders.json --dry-run
```

---

## ملخص

| الهدف | الإجراء |
|--------|---------|
| ربط عدة طلبات سابقة دفعة واحدة | تصدير من سلة → تحويل لـ `past-orders.json` → تشغيل `node scripts/backfill-past-orders.js past-orders.json` |
| ربط طلب واحد معروف | استخدام `scripts/add-subscription-by-phone.sql` (أو ما يعادله للبريد) في Supabase |
| التحقق من الطلبات غير المربوطة | تشغيل السكربت مع `--dry-run` أو مقارنة قائمة الطلبات المُصدَّرة مع جدول `subscriptions` يدوياً |

بعد الربط، تأكد في التطبيق أو من جدول **subscriptions** أن الاشتراكات تظهر للمستخدمين الصحيحين.
